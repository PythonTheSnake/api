machine:
  timezone:
    Europe/Berlin
  services:
    - docker

dependencies:
  cache_directories:
    - /home/ubuntu/api/redis-2.8.18
  pre:
    - source /etc/lsb-release && echo "deb http://download.rethinkdb.com/apt $DISTRIB_CODENAME main" | sudo tee /etc/apt/sources.list.d/rethinkdb.list
    - wget -qO- http://download.rethinkdb.com/apt/pubkey.gpg | sudo apt-key add -
    - sudo apt-get update
    - sudo apt-get install rethinkdb
    - if [[ ! -e redis-2.8.18/src/redis-server ]]; then wget http://download.redis.io/releases/redis-2.8.18.tar.gz && tar xvzf redis-2.8.18.tar.gz; fi
    - if [[ ! -e redis-2.8.18/src/redis-server ]]; then cd redis-2.8.18 && make; fi
    - go get github.com/apcera/gnatsd
    - go get golang.org/x/tools/cmd/cover
    - go get github.com/mattn/goveralls
  post:
    - rethinkdb --bind all:
        background: true
    - src/redis-server:
        background: true
    - gnatsd:
        background: true

test:
  override:
    - go test -v -covermode=count -coverprofile=coverage.out ./...
    - goveralls -coverprofile=coverage.out -service=circleci -repotoken $COVERALLS_TOKEN

deployment:
  hub:
    branch: master
    commands:
      - docker login -e circleci@lavaboom.io -u $DOCKER_USER -p $DOCKER_PASS https://registry.lavaboom.io
      - docker build -t registry.lavaboom.io/lavaboom/api .
      - docker push registry.lavaboom.io/lavaboom/api