# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile API/syntax version. Don't touch unless you know what you're doing!
VAGRANTFILE_API_VERSION = "2"

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  #config.vm.define "redisthink" do |rethinkdb|
    #rethinkdb.vm.box = "ubuntu/trusty64"

    # rethinkdb
    #rethinkdb.vm.network "forwarded_port", guest: 8080, host: 8080
    #rethinkdb.vm.network "forwarded_port", guest: 28015, host: 28015
    #rethinkdb.vm.network "forwarded_port", guest: 29015, host: 29015

    # redis
    #rethinkdb.vm.network "forwarded_port", guest: 6379, host: 6379

    #rethinkdb.vm.provider "virtualbox" do |v|
    #v.memory = 2048
    #v.cpus = 4
    #end

    # load ansible playbook
    #rethinkdb.vm.provision "shell", path: "deploy.sh"
  #end

  config.vm.define "docker" do |docker|
    docker.vm.box = "ubuntu/trusty64"

    docker.vm.network "forwarded_port", guest: 4160, host: 4160
    docker.vm.network "forwarded_port", guest: 4161, host: 4161
    docker.vm.network "forwarded_port", guest: 4150, host: 4150
    docker.vm.network "forwarded_port", guest: 4151, host: 4151
    docker.vm.network "forwarded_port", guest: 6379, host: 6379
    docker.vm.network "forwarded_port", guest: 8080, host: 8080
    docker.vm.network "forwarded_port", guest: 28015, host: 28015
    docker.vm.network "forwarded_port", guest: 29015, host: 29015

    docker.vm.provider "virtualbox" do |v|
      v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
      v.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
    end

    docker.vm.provision "docker" do |d|
      d.pull_images "nsqio/nsqlookupd"
      d.run "nsqio/nsqlookupd",
        args: "--name lookupd -p 4160:4160 -p 4161:4161"

      d.pull_images "nsqio/nsqd"
      d.run "nsqio/nsqd",
        args: "--name nsqd -p 4150:4150 -p 4151:4151",
        cmd: "--broadcast-address=172.17.42.1 --lookupd-tcp-address=172.17.42.1:4160"

      d.pull_images "dockerfile/rethinkdb"
      d.run "dockerfile/rethinkdb",
        args: "--name rethinkdb -p 8080:8080 -p 28015:28015 -p 29015:29015"

      d.pull_images "dockerfile/redis"
      d.run "dockerfile/redis",
        args: "--name redis -p 6379:6379"
    end
  end
end
